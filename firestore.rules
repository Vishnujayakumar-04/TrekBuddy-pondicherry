rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // User Profiles
    match /users/{userId} {
      // Allow user to read/write their own profile
      allow get: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      // Allow user to manage their favorites subcollection
      match /favorites/{favoriteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Trips Collection
    match /trips/{tripId} {
      // Allow read if user owns the trip (must query with where('userId', '==', auth.uid))
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Allow create if user assigns the trip to themselves 
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Allow update/delete if user owns the trip
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Itinerary Items - Nested under trips
    match /trips/{tripId}/items/{itemId} {
        allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid;
    }
    
    // Places Collection - Public read, admin write
    match /places/{placeId} {
      allow read: if true;
      allow write: if false; 
    }
    
    // Knowledge Base
    match /knowledge/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // AI Cache 
    match /ai_cache/{docId} {
      allow read: if true;
      allow create: if request.auth != null; 
      allow update, delete: if false;
    }
    
    // Transit Data 
    match /transit/{docId} {
      allow read: if true;
      allow write: if request.auth != null; 
    }
    
    // Chat History 
    match /chats/{chatId} {
        allow read: if request.auth != null && resource.data.userId == request.auth.uid;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
